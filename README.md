# Synergy ID Repository

A modern web application to manage and browse ID profiles for staff, students, and parents, powered by React, Supabase, and the Gemini API.

## Features

-   **User Authentication**: Secure login system powered by Supabase Auth, with admin approval for new sign-ups.
-   **Automated Admin Setup**: The very first user to sign up is automatically granted admin privileges.
-   **Admin Dashboard**: A protected area for administrators to approve new users, manage their roles (admin/user), delete users, and configure application settings (like the Google Sheet ID).
-   **Optimized Image Handling**: Profile photos are stored in Supabase Storage for fast, efficient delivery, preventing API timeouts and improving load times.
-   **Google Sheet Integration**: Automatically retrieves a student's unique ID from a designated public Google Sheet upon profile creation, ensuring data consistency.
-   **Categorized Profiles**: Create and manage profiles for Staff, Students, and Parents.
-   **Dynamic Bio Generation**: Uses the Gemini API to automatically generate a professional bio for each new profile.
-   **Profile Associations**: Link students to their guardians (who can be parents or staff).
-   **Persistent & Secure Storage**: Data is stored in a Supabase database, protected by Row Level Security.

## Tech Stack

-   **Frontend**: React, Vite, Tailwind CSS
-   **Backend**: Hono on Vercel Serverless Functions
-   **Database, Auth & Storage**: Supabase
-   **AI**: Google Gemini API
-   **Data Source**: Google Sheets API

---

## Local Development Setup

Follow these steps to get the project running on your local machine.

### 1. Prerequisites

-   Node.js (v18 or later)
-   `npm` or `yarn`
-   A Supabase account with a project created.
-   A Google Cloud account and a Google Sheet.
-   A Google Cloud API Key (can be the same one used for Gemini).

### 2. Installation

1.  **Clone and install dependencies:**
    ```bash
    git clone <your-repository-url>
    cd synergy-id-repository
    npm install
    ```

### 3. Environment Variables

1.  **Create an environment file:** Copy `.env.example` to `.env`.
    ```bash
    cp .env.example .env
    ```

2.  **Fill in the variables:** Open `.env` and add your credentials. See the sections below for details on where to find these values.
    ```ini
    # Supabase connection details (for frontend)
    VITE_SUPABASE_URL="your_supabase_project_url"
    VITE_SUPABASE_ANON_KEY="your_supabase_public_anon_key"

    # Supabase connection details (for backend serverless functions & scripts)
    SUPABASE_URL="your_supabase_project_url"
    SUPABASE_ANON_KEY="your_supabase_public_anon_key"
    SUPABASE_SERVICE_KEY="your_supabase_service_role_key"

    # Google Cloud API Key (used for Gemini and Google Sheets)
    API_KEY_ALIAS_FOR_GEMINI="your_google_cloud_api_key"
    
    # Google Sheets Integration (for retrieving student IDs)
    # Note: The Google Sheet ID is now configured in the Admin Dashboard.
    GOOGLE_SHEET_NAME="Sheet1" # The name of the sheet/tab to search in
    ```

### 4. Supabase Configuration

#### Step 4.1: Enable Authentication & Email Confirmation

-   In your Supabase Dashboard, go to **Authentication** -> **Providers**.
-   Enable the **Email** provider.
-   Go to **Authentication** -> **Settings**.
-   In the **Email** section, turn **ON** the "Confirm email" toggle. This is **CRUCIAL** for the admin approval flow to work.

#### Step 4.2: Create Storage Bucket for Profile Images

-   In your Supabase Dashboard, go to **Storage**.
-   Click **New bucket**.
-   Enter `avatars` as the bucket name.
-   Toggle **ON** the "This bucket is public" setting.
-   Click **Create bucket**.

#### Step 4.3: Create Database Schema and Security Rules

> **IMPORTANT:** You must run the following SQL script in your Supabase SQL Editor. This step is required to create the necessary tables and security policies. If you encounter permission errors in the app, it's likely because this script was not run on your database.

-   Go to the **SQL Editor** in your Supabase dashboard.
-   Click **New query** and paste the **entire** SQL script below into the editor, then click **Run**.

    ```sql
    -- 1. Create the 'people' table
    CREATE TABLE IF NOT EXISTS public.people (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      category VARCHAR(20) NOT NULL,
      "firstName" VARCHAR(50) NOT NULL,
      "lastName" VARCHAR(50) NOT NULL,
      image TEXT NOT NULL,
      role VARCHAR(50),
      class VARCHAR(50),
      "guardianIds" BIGINT[],
      bio TEXT NOT NULL,
      "googleSheetId" VARCHAR(20) NOT NULL,
      "createdAt" TIMESTAMPTZ DEFAULT NOW() NOT NULL
    );

    -- 2. Create the 'settings' table
    CREATE TABLE IF NOT EXISTS public.settings (
      key TEXT PRIMARY KEY,
      value TEXT
    );

    -- 3. Create the 'is_admin' function for RLS
    CREATE OR REPLACE FUNCTION is_admin()
    RETURNS BOOLEAN
    LANGUAGE SQL
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT COALESCE((auth.jwt() -> 'user_metadata' ->> 'role') = 'admin', FALSE)
    $$;

    -- 4. Apply Row Level Security (RLS) policies for tables
    ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;
    DROP POLICY IF EXISTS "Allow authenticated read access" ON public.people;
    CREATE POLICY "Allow authenticated read access" ON public.people FOR SELECT TO authenticated USING (TRUE);
    DROP POLICY IF EXISTS "Allow authenticated insert access" ON public.people;
    CREATE POLICY "Allow authenticated insert access" ON public.people FOR INSERT TO authenticated WITH CHECK (TRUE);
    DROP POLICY IF EXISTS "Allow admin update access" ON public.people;
    CREATE POLICY "Allow admin update access" ON public.people FOR UPDATE USING (is_admin()) WITH CHECK (is_admin());

    ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;
    DROP POLICY IF EXISTS "Allow authenticated read access on settings" ON public.settings;
    CREATE POLICY "Allow authenticated read access on settings" ON public.settings FOR SELECT TO authenticated USING (TRUE);
    DROP POLICY IF EXISTS "Allow admin insert access on settings" ON public.settings;
    CREATE POLICY "Allow admin insert access on settings" ON public.settings FOR INSERT WITH CHECK (is_admin());
    DROP POLICY IF EXISTS "Allow admin update access on settings" ON public.settings;
    CREATE POLICY "Allow admin update access on settings" ON public.settings FOR UPDATE USING (is_admin()) WITH CHECK (is_admin());

    -- 5. Create a trigger to make the first user an admin
    CREATE OR REPLACE FUNCTION public.grant_first_user_admin()
    RETURNS TRIGGER
    LANGUAGE plpgsql
    SECURITY DEFINER
    AS $$
    BEGIN
      -- Check if this is the very first user
      IF (SELECT count(*) FROM auth.users) = 1 THEN
        -- If so, grant admin role and confirm their email
        UPDATE auth.users
        SET
          user_metadata = jsonb_set(
            COALESCE(user_metadata, '{}'::jsonb),
            '{role}',
            '"admin"'::jsonb
          ),
          email_confirmed_at = NOW()
        WHERE id = NEW.id;
      END IF;
      RETURN NEW;
    END;
    $$;

    -- Drop the trigger if it already exists to ensure idempotency
    DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

    -- Add the trigger to the auth.users table
    CREATE TRIGGER on_auth_user_created
      AFTER INSERT ON auth.users
      FOR EACH ROW EXECUTE FUNCTION public.grant_first_user_admin();

    -- 6. Create Storage bucket policies for 'avatars'
    -- This assumes you have already created a PUBLIC bucket named 'avatars' in the UI.
    DROP POLICY IF EXISTS "Allow authenticated uploads to avatars" ON storage.objects;
    CREATE POLICY "Allow authenticated uploads to avatars"
    ON storage.objects FOR INSERT TO authenticated
    WITH CHECK ( bucket_id = 'avatars' );

    DROP POLICY IF EXISTS "Allow public read access to avatars" ON storage.objects;
    CREATE POLICY "Allow public read access to avatars"
    ON storage.objects FOR SELECT
    USING ( bucket_id = 'avatars' );
    ```

#### Step 4.4: Seed the database

-   This script will check if your tables exist and seed them with initial data if they are empty.
    ```bash
    npm run db:setup
    ```
    
### 5. Google Sheets Integration

To allow the application to read Student IDs from your spreadsheet, you need to enable the Google Sheets API and make your sheet public.

1.  **Enable the Google Sheets API:**
    -   Go to the [Google Cloud Console](https://console.cloud.google.com/).
    -   Select your project.
    -   Navigate to **APIs & Services** -> **Library**.
    -   Search for "Google Sheets API" and click **Enable**.
    -   Ensure your API key (from `API_KEY_ALIAS_FOR_GEMINI`) is not restricted from accessing this API.

2.  **Share your Google Sheet:**
    -   Open your Google Sheet.
    -   Click the **Share** button in the top-right corner.
    -   Under "General access", change the setting from "Restricted" to **"Anyone with the link"**.
    -   Ensure the role is set to **"Viewer"**.
    -   Click **Done**.

3.  **Configure in Admin Dashboard:**
    -   Once you are logged in as an admin, go to the **Admin** page.
    -   Find the "Google Sheet ID" field.
    -   Get this ID from your sheet's URL: `https://docs.google.com/spreadsheets/d/THIS_IS_THE_ID/edit`.
    -   Paste the ID into the field and save.

### 6. Create Your Admin User

-   If you have already signed up with any users, **delete them** from the Supabase **Authentication** -> **Users** panel.
-   Run the app:
    ```bash
    npm run dev
    ```
-   Sign up for a new account. The first account created will automatically become an administrator.

---

## Deployment to Vercel

1.  **Import Project on Vercel:**
    -   Import your Git repository into Vercel.

2.  **Configure Environment Variables:**
    -   In the Vercel project settings, add all the environment variables from your `.env` file (except for `GOOGLE_SHEET_ID`, which is managed in the app).
    -   Click "Deploy".