# Synergy ID Repository

A modern web application to manage and browse ID profiles for staff, students, and parents, powered by React, Supabase, and the Gemini API.

## Features

-   **User Authentication**: Secure login system powered by Supabase Auth.
-   **Admin Dashboard**: A protected area for administrators to manage application settings.
-   **Configurable Google Sheet Link**: Admins can set a URL for Google Sheets, turning profile IDs into dynamic links.
-   **Categorized Profiles**: Create and manage profiles for Staff, Students, and Parents.
-   **Dynamic Bio Generation**: Uses the Gemini API to automatically generate a professional bio for each new profile.
-   **Profile Associations**: Link students to their guardians.
-   **Persistent & Secure Storage**: Data is stored in a Supabase database, protected by Row Level Security.

## Tech Stack

-   **Frontend**: React, Vite, Tailwind CSS
-   **Backend**: Hono on Vercel Serverless Functions
-   **Database & Auth**: Supabase
-   **AI**: Google Gemini API

---

## Local Development Setup

Follow these steps to get the project running on your local machine.

### 1. Prerequisites

-   Node.js (v18 or later)
-   `npm` or `yarn`
-   A Supabase account with a project created.
-   A Google Gemini API Key.

### 2. Installation

1.  **Clone and install dependencies:**
    ```bash
    git clone <your-repository-url>
    cd synergy-id-repository
    npm install
    ```

### 3. Environment Variables

1.  **Create an environment file:** Copy `.env.example` to `.env`.
    ```bash
    cp .env.example .env
    ```

2.  **Fill in the variables:** Open `.env` and add your credentials. Frontend variables **must** be prefixed with `VITE_`.
    ```ini
    # Supabase connection details (for frontend)
    VITE_SUPABASE_URL="your_supabase_project_url"
    VITE_SUPABASE_ANON_KEY="your_supabase_public_anon_key"

    # Supabase connection details (for backend serverless functions & scripts)
    SUPABASE_URL="your_supabase_project_url"
    SUPABASE_ANON_KEY="your_supabase_public_anon_key"
    SUPABASE_SERVICE_KEY="your_supabase_service_role_key"

    # Google Gemini API Key
    API_KEY_ALIAS_FOR_GEMINI="your_gemini_api_key"
    ```

### 4. Supabase Configuration

#### Step 4.1: Enable Authentication

-   In your Supabase Dashboard, go to **Authentication** -> **Providers**.
-   Enable the **Email** provider. Leave the other settings as default for now.

#### Step 4.2: Create Database Tables & Security Functions

-   Go to the **SQL Editor** in your Supabase dashboard and run the following queries one by one.

-   **Query 1: Create the `people` table**
    ```sql
    CREATE TABLE public.people (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      category VARCHAR(20) NOT NULL,
      "firstName" VARCHAR(50) NOT NULL,
      "lastName" VARCHAR(50) NOT NULL,
      image TEXT NOT NULL,
      role VARCHAR(50),
      class VARCHAR(50),
      "guardianIds" BIGINT[],
      bio TEXT NOT NULL,
      "googleSheetId" VARCHAR(20) NOT NULL,
      "createdAt" TIMESTAMPTZ DEFAULT NOW() NOT NULL
    );
    ```

-   **Query 2: Create the `settings` table**
    ```sql
    CREATE TABLE public.settings (
      key TEXT PRIMARY KEY,
      value TEXT
    );
    ```

-   **Query 3: Create the `is_admin` security function** (This checks for a role in user metadata)
    ```sql
    CREATE OR REPLACE FUNCTION is_admin()
    RETURNS BOOLEAN
    LANGUAGE SQL
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT COALESCE((auth.jwt() -> 'user_metadata' ->> 'role') = 'admin', FALSE)
    $$;
    ```

#### Step 4.3: Enable Row Level Security (RLS)

-   Run these queries in the **SQL Editor** to secure your tables.

-   **Query 1: Secure the `people` table**
    ```sql
    -- Enable RLS on the people table
    ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;

    -- Allow logged-in users to read all profiles
    CREATE POLICY "Allow authenticated read access" ON public.people
    FOR SELECT TO authenticated USING (TRUE);

    -- Allow logged-in users to create new profiles
    CREATE POLICY "Allow authenticated insert access" ON public.people
    FOR INSERT TO authenticated WITH CHECK (TRUE);
    ```

-   **Query 2: Secure the `settings` table**
    ```sql
    -- Enable RLS on the settings table
    ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;

    -- Allow logged-in users to read settings
    CREATE POLICY "Allow authenticated read access on settings" ON public.settings
    FOR SELECT TO authenticated USING (TRUE);

    -- Allow ONLY admins to update settings
    CREATE POLICY "Allow admin update access on settings" ON public.settings
    FOR UPDATE USING (is_admin()) WITH CHECK (is_admin());
    ```

#### Step 4.4: Seed the database

-   Run the setup script. It will check for your tables and seed them with initial data if they are empty.
    ```bash
    npm run db:setup
    ```

### 5. Create an Admin User

-   Run the app (`npm run dev`) and sign up for a new account.
-   Go to your Supabase Dashboard -> **Authentication** -> **Users**.
-   Find the user you just created, click the three dots, and select **Edit user**.
-   In the **User Metadata** section, add the following to give the user admin privileges:
    ```json
    {
      "role": "admin"
    }
    ```
-   Click **Save**. Now, when you log in with this user, you will see the "Admin" dashboard.

### 6. Running the Development Server

```bash
npm run dev
```
The application should now be running at `http://localhost:5173`.

---

## Deployment to Vercel

1.  **Import Project on Vercel:**
    -   Import your Git repository into Vercel.

2.  **Configure Environment Variables:**
    -   In the Vercel project settings, add the following environment variables from your `.env` file:
        -   `VITE_SUPABASE_URL`
        -   `VITE_SUPABASE_ANON_KEY`
        -   `SUPABASE_URL`
        -   `SUPABASE_ANON_KEY`
        -   `API_KEY_ALIAS_FOR_GEMINI`
    -   **Important**: Do not add `SUPABASE_SERVICE_KEY` to Vercel's environment variables unless you have specific backend needs for it beyond the setup script. It's a security risk if exposed.
    -   Click "Deploy".