# Synergy ID Repository

A modern web application to manage and browse ID profiles for staff, students, and parents, powered by React, Supabase, and the Gemini API.

## Features

-   **User Authentication**: Secure login system powered by Supabase Auth, with admin approval for new sign-ups.
-   **Automated Admin Setup**: The very first user to sign up is automatically granted admin privileges.
-   **Admin Dashboard**: A protected area for administrators to approve new users and manage application settings.
-   **Configurable Google Sheet Link**: Admins can set a URL for Google Sheets, turning profile IDs into dynamic links.
-   **Categorized Profiles**: Create and manage profiles for Staff, Students, and Parents.
-   **Dynamic Bio Generation**: Uses the Gemini API to automatically generate a professional bio for each new profile.
-   **Profile Associations**: Link students to their guardians (who can be parents or staff).
-   **Persistent & Secure Storage**: Data is stored in a Supabase database, protected by Row Level Security.

## Tech Stack

-   **Frontend**: React, Vite, Tailwind CSS
-   **Backend**: Hono on Vercel Serverless Functions
-   **Database & Auth**: Supabase
-   **AI**: Google Gemini API

---

## Local Development Setup

Follow these steps to get the project running on your local machine.

### 1. Prerequisites

-   Node.js (v18 or later)
-   `npm` or `yarn`
-   A Supabase account with a project created.
-   A Google Gemini API Key.

### 2. Installation

1.  **Clone and install dependencies:**
    ```bash
    git clone <your-repository-url>
    cd synergy-id-repository
    npm install
    ```

### 3. Environment Variables

1.  **Create an environment file:** Copy `.env.example` to `.env`.
    ```bash
    cp .env.example .env
    ```

2.  **Fill in the variables:** Open `.env` and add your credentials. Frontend variables **must** be prefixed with `VITE_`.
    ```ini
    # Supabase connection details (for frontend)
    VITE_SUPABASE_URL="your_supabase_project_url"
    VITE_SUPABASE_ANON_KEY="your_supabase_public_anon_key"

    # Supabase connection details (for backend serverless functions & scripts)
    SUPABASE_URL="your_supabase_project_url"
    SUPABASE_ANON_KEY="your_supabase_public_anon_key"
    SUPABASE_SERVICE_KEY="your_supabase_service_role_key"

    # Google Gemini API Key
    API_KEY_ALIAS_FOR_GEMINI="your_gemini_api_key"
    ```

### 4. Supabase Configuration

#### Step 4.1: Enable Authentication & Disable Email Confirmation

-   In your Supabase Dashboard, go to **Authentication** -> **Providers**.
-   Enable the **Email** provider.
-   Go to **Authentication** -> **Settings**.
-   In the **Email** section, turn **OFF** the "Confirm email" toggle. This is crucial for the admin approval flow to work correctly (the first admin's email will be confirmed automatically by our script).

#### Step 4.2: Create Database Schema and Security Rules

-   Go to the **SQL Editor** in your Supabase dashboard.
-   Click **New query** and paste the **entire** SQL script below into the editor, then click **Run**. This single script creates all tables, functions, security policies, and the trigger for automatic admin setup.

    ```sql
    -- 1. Create the 'people' table
    CREATE TABLE public.people (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      category VARCHAR(20) NOT NULL,
      "firstName" VARCHAR(50) NOT NULL,
      "lastName" VARCHAR(50) NOT NULL,
      image TEXT NOT NULL,
      role VARCHAR(50),
      class VARCHAR(50),
      "guardianIds" BIGINT[],
      bio TEXT NOT NULL,
      "googleSheetId" VARCHAR(20) NOT NULL,
      "createdAt" TIMESTAMPTZ DEFAULT NOW() NOT NULL
    );

    -- 2. Create the 'settings' table
    CREATE TABLE public.settings (
      key TEXT PRIMARY KEY,
      value TEXT
    );

    -- 3. Create the 'is_admin' function for RLS
    CREATE OR REPLACE FUNCTION is_admin()
    RETURNS BOOLEAN
    LANGUAGE SQL
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT COALESCE((auth.jwt() -> 'user_metadata' ->> 'role') = 'admin', FALSE)
    $$;

    -- 4. Apply Row Level Security (RLS) policies
    ALTER TABLE public.people ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Allow authenticated read access" ON public.people FOR SELECT TO authenticated USING (TRUE);
    CREATE POLICY "Allow authenticated insert access" ON public.people FOR INSERT TO authenticated WITH CHECK (TRUE);
    CREATE POLICY "Allow admin update access" ON public.people FOR UPDATE USING (is_admin()) WITH CHECK (is_admin());

    ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;
    CREATE POLICY "Allow authenticated read access on settings" ON public.settings FOR SELECT TO authenticated USING (TRUE);
    CREATE POLICY "Allow admin update access on settings" ON public.settings FOR UPDATE USING (is_admin()) WITH CHECK (is_admin());

    -- 5. Create a trigger to make the first user an admin
    CREATE OR REPLACE FUNCTION public.grant_first_user_admin()
    RETURNS TRIGGER
    LANGUAGE plpgsql
    SECURITY DEFINER
    AS $$
    BEGIN
      -- Check if this is the very first user
      IF (SELECT count(*) FROM auth.users) = 1 THEN
        -- If so, grant admin role and confirm their email
        UPDATE auth.users
        SET
          user_metadata = jsonb_set(
            COALESCE(user_metadata, '{}'::jsonb),
            '{role}',
            '"admin"'::jsonb
          ),
          email_confirmed_at = NOW()
        WHERE id = NEW.id;
      END IF;
      RETURN NEW;
    END;
    $$;

    -- Drop the trigger if it already exists to ensure idempotency
    DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

    -- Add the trigger to the auth.users table
    CREATE TRIGGER on_auth_user_created
      AFTER INSERT ON auth.users
      FOR EACH ROW EXECUTE FUNCTION public.grant_first_user_admin();
    ```

#### Step 4.3: Seed the database

-   This script will check if your tables exist and seed them with initial data if they are empty.
    ```bash
    npm run db:setup
    ```

### 5. Create Your Admin User

-   If you have already signed up with any users, **delete them** from the Supabase **Authentication** -> **Users** panel.
-   Run the app:
    ```bash
    npm run dev
    ```
-   Sign up for a new account. The first account created will automatically become an administrator. You will be logged in immediately and will see the "Admin" button in the header.

---

## Deployment to Vercel

1.  **Import Project on Vercel:**
    -   Import your Git repository into Vercel.

2.  **Configure Environment Variables:**
    -   In the Vercel project settings, add the following environment variables from your `.env` file:
        -   `VITE_SUPABASE_URL`
        -   `VITE_SUPABASE_ANON_KEY`
        -   `SUPABASE_URL`
        -   `SUPABASE_ANON_KEY`
        -   `API_KEY_ALIAS_FOR_GEMINI`
        -   `SUPABASE_SERVICE_KEY` (Required for admin functions like user approval)
    -   Click "Deploy".
